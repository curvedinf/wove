============================= test session starts ==============================
platform linux -- Python 3.12.5, pytest-8.4.0, pluggy-1.6.0
rootdir: /home/chase/Projects/wove
configfile: setup.cfg
plugins: cov-6.2.1, anyio-4.9.0, asyncio-1.1.0, django-4.11.1
asyncio: mode=Mode.AUTO, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 17 items

tests/test_core.py .......                                               [ 41%]
tests/test_mapping.py .........F                                         [100%]

=================================== FAILURES ===================================
_______________________ test_error_in_map_cancels_others _______________________

    @pytest.mark.asyncio
    async def test_error_in_map_cancels_others():
        """Tests that an exception in one mapped sub-task cancels others."""
        items = ["ok_long", "fail", "ok"]
    
        long_task_started = asyncio.Event()
        long_task_cancelled = False
        with pytest.raises(ValueError, match="Task failed on item: fail"):
            async with weave() as w:
                @w.do(items)
                async def process_item_with_failure(item):
                    nonlocal long_task_cancelled
                    if item == "ok":
                        await asyncio.sleep(0.1) # should get cancelled
                        return "ok"
                    elif item == "fail":
                        await long_task_started.wait() # Make sure the long one starts
                        raise ValueError("Task failed on item: fail")
                    elif item == "ok_long":
                        long_task_started.set()
                        try:
                            await asyncio.sleep(0.2) # Long enough to be cancelled
                        except asyncio.CancelledError:
                            long_task_cancelled = True
                            raise
                        return "long_ok"
>       assert long_task_cancelled, "The long-running sub-task should have been cancelled."
E       AssertionError: The long-running sub-task should have been cancelled.
E       assert False

tests/test_mapping.py:149: AssertionError
=========================== short test summary info ============================
FAILED tests/test_mapping.py::test_error_in_map_cancels_others - AssertionErr...
========================= 1 failed, 16 passed in 0.26s =========================
